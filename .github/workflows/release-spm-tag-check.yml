name: Release Validation

on:
  push:
    tags:
      - 'v*'  # Only run when pushing semantic style tags (ex: v1.0.0)

jobs:
  validate-spm-tag:
    name: Validate SPM Release Tag
    runs-on: macos-14
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required to check tags

      - name: Validate tag format
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Tag '$TAG' is not SemVer formatted (vX.Y.Z)"
            exit 1
          fi
          echo "‚úÖ Valid tag format: $TAG"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Swift Package Resolve
        run: swift package resolve --package-path ${{ github.workspace }}

      - name: Build
        run: |
          xcodebuild \
            -scheme concordium-id-swift-sdk \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Release \
            clean build

      - name: Run tests
        run: |
          xcodebuild \
            -scheme concordium-id-swift-sdk \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Release \
            test

      - name: SwiftLint
        run: |
          if command -v swiftlint > /dev/null; then
            swiftlint
          else
            echo "‚ö†Ô∏è SwiftLint not installed ‚Äì skipping lint"
          fi

      - name: Confirm Package.swift Version Matches Tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION_IN_FILE=$(grep -oE '[0-9]+\.[0-9]+\.[0-9]+' Package.swift | head -n 1)

          echo "üìÑ Package.swift version: $VERSION_IN_FILE"
          echo "üè∑ Git tag version: ${TAG#v}"

          if [[ "${TAG#v}" != "$VERSION_IN_FILE" ]]; then
            echo "‚ùå Version in Package.swift does NOT match tag."
            exit 1
          fi

          echo "‚úÖ Version validation success."
